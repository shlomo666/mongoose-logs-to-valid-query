<link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

<div style="padding: 10px; font-family: Arial, Helvetica, sans-serif;">
  <label for="maxCollapse">Max chars for collapse: </label>
  <input
    type="number"
    name="maxCollapse"
    id="maxCollapse"
    value="40"
    onchange="action()"
  /><br />
  <input type="checkbox" name="shouldIds" id="shouldIds" onchange="action()" />
  <label id="shouldIdsLabel" for="shouldIds"
    >Replace string ids with ObjectId</label
  ><br />
  <input
    type="checkbox"
    name="shouldDates"
    id="shouldDates"
    onchange="action()"
  />
  <label id="shouldDatesLabel" for="shouldDates"
    >Replace string dates with Date</label
  ><br />
</div>

<div>
  <textarea
    name="input"
    id="inputCode"
    style="font-size: 15px; font-family: monaco; height: 100%; width: 30%; float: left;"
    placeholder="Paste Mongoose query from DAL logs here"
    oninput="action()"
    spellcheck="false"
  ></textarea>
  <textarea
    name="output"
    id="outputCode"
    style="font-size: 15px; font-family: monaco; height: 100%; width: 70%; float: right;"
  ></textarea>
</div>

<script>
  const DEFAULT_MAX_COLLAPSE = 50;

  document.getElementById("shouldIds").checked =
    localStorage.shouldIds === "true";
  document.getElementById("shouldDates").checked =
    localStorage.shouldDates === "true";
  document.getElementById("maxCollapse").value =
    Number(localStorage.maxCollapse) || DEFAULT_MAX_COLLAPSE;

  const input = document.getElementById("inputCode");
  const output = document.getElementById("outputCode");

  function action() {
    markOptionsUsage();

    const shouldReplaceStringIds = document.getElementById("shouldIds").checked;
    const shouldReplaceStringDates = document.getElementById("shouldDates")
      .checked;
    const MAX_COLLAPSE =
      Number(document.getElementById("maxCollapse").value) ||
      DEFAULT_MAX_COLLAPSE;

    localStorage.shouldIds = shouldReplaceStringIds;
    localStorage.shouldDates = shouldReplaceStringDates;
    localStorage.maxCollapse = MAX_COLLAPSE;

    const txt = input.value;
    const originalArr = txt.substring(
      txt.indexOf("["),
      txt.lastIndexOf("]") + 1
    );

    let arr = originalArr;
    if (shouldReplaceStringIds) {
      arr = replaceStringIds(arr);
    }
    if (shouldReplaceStringDates) {
      arr = replaceStringDates(arr);
    }
    arr = format(arr);
    arr = removeQuotes(arr);
    arr = collapse(arr, MAX_COLLAPSE);

    output.value = "db." + txt.replace(originalArr, arr);
  }

  function format(s) {
    map.clear();

    const exchanged = s
      .replace(
        / \/[^\n]+\/[a-z]+/g,
        s => ` "${exchange(s.slice(1), "Regexp")}"`
      )
      .replace(/ (\w{24})/g, (s, id) => ` "${exchange(id, "ObjectId")}"`)
      .replace(
        / \d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(.\d{1,3})?Z/g,
        s => ` "${exchange(s.slice(1), "Date")}"`
      )
      .replace(/'|`/g, '"');
    let stringified = JSON.stringify(eval(exchanged), null, 2);
    map.forEach(
      (v, k) =>
        (stringified = stringified
          .split(`"${v}"`)
          .join(`${v.split("_")[0]}("${k}")`))
    );
    return stringified.replace(/Regexp\("([^\n]+)"\)/g, (s, regex) => regex);
  }

  const map = new Map();
  function exchange(s, prefix) {
    if (!map.has(s)) {
      map.set(s, prefix + "_" + Math.random());
    }
    return map.get(s);
  }

  function removeQuotes(txt) {
    return txt.replace(/"([\$\w]+)": /g, (_, s) => s + ": ");
  }

  function collapse(txt, MAX_COLLAPSE) {
    for (let i = 0; i < txt.length; i++) {
      if (txt[i] === "{" || txt[i] === "[") {
        let depthCounter = 1;
        let letterCounter = 1;
        let j = i;
        while (depthCounter > 0 && letterCounter < MAX_COLLAPSE) {
          j++;
          if (txt[j] === "{" || txt[j] === "[") depthCounter++;
          else if (txt[j] === "}" || txt[j] === "]") depthCounter--;
          if (txt[j].trim().length > 0) letterCounter++;
        }
        if (depthCounter === 0) {
          const partialString = txt.substring(i, j + 1);
          txt = txt.replace(
            partialString,
            partialString
              .split("\n")
              .map(p => p.trim())
              .join(" ")
          );
        }
      }
    }

    return txt;
  }

  function replaceStringIds(txt) {
    return txt.replace(/"\w{24}"/g, s => s.slice(1, -1));
  }

  function replaceStringDates(txt) {
    return txt.replace(
      /"\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(.\d{1,3})?Z"/g,
      s => s.slice(1, -1)
    );
  }

  function markOptionsUsage() {
    const txt = input.value;
    document.getElementById("shouldIdsLabel").style.background =
      replaceStringIds(txt) !== txt ? "gainsboro" : "none";
    document.getElementById("shouldDatesLabel").style.background =
      replaceStringDates(txt) !== txt ? "gainsboro" : "none";
  }
</script>
